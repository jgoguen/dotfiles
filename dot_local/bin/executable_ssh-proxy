#!/bin/sh
# vim: set noexpandtab tabstop=2 shiftwidth=2 autoindent:
# vim: set foldmarker=[[[,]]] foldmethod=marker foldlevel=0:
# Do not edit this file directly! It is managed by chezmoi.

ip_list="${1}"
port="${2:-22}"
if [ -z "${ip_list}" ] || [ ! -f "${ip_list}" ]; then
	printf "Provide a file listing IP addresses\n" >&2
	exit 1
fi

ip_addr=''
iter=0
max_iter=5
while [ "${ip_addr}" = "" ] && [ "${iter}" -lt "${max_iter}" ]; do
	ip_addr=$(/usr/bin/shuf -n 1 "${ip_list}")
	iter=$(( iter + 1 ))
done

if [ "${ip_addr}" = "" ]; then
	printf "Could not find an IP address after %d attempts\n" "${max_iter}" >&2
	exit 1
fi

case "${ip_addr}" in
	*:*)
		ip_addr="[${ip_addr}]"
		;;
esac

/usr/bin/socat stdio tcp:"${ip_addr}":"${port}"
