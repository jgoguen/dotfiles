#!/bin/sh
# vim: set noexpandtab tabstop=2 shiftwidth=2 autoindent:
# vim: set foldmarker=[[[,]]] foldmethod=marker foldlevel=0:
# Do not edit this file directly! It is managed by chezmoi.

if [ -z "${HG}" ]; then
	 HG="$(command -v hg)"
fi

# 'set -e' causes the script to exit when a command fails. This isn't always
# desired; these cases are wrapped in 'set +e' ... 'set -e'.
set -eu

SHELVE_NAME="hg-master-sync"

set +e
# First, check if we're on master. We need this later to decide if we update to
# master after rebasing.
BOOKMARKS=$(${HG} log -r . -T '{remotebookmarks}' | /bin/grep 'remote/master')

# Try to shelve changes
${HG} shelve -n "${SHELVE_NAME}"; SHELVE_RV=$?
set -e

${HG} pull
${HG} rebase -s 'draft()' -d master; REBASE_RV=$?

if [ "${REBASE_RV}" = 0 ]; then
	 if [ -n "${BOOKMARKS}" ]; then
		${HG} update master
	 fi

	 if [ "${SHELVE_RV}" = 0 ]; then
		${HG} unshelve -n "${SHELVE_NAME}"
	 fi

	 ${HG} sl
fi
